<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅 메인</title>

    <style>
        body{
            background-color: lightgray;
        }
        #wrapper {
            width: 1200px;
            height: 800px;
            margin: 0 auto;
            background: azure;
        }
        #aside {
            width: 200px;
            height: 100%;
            background: bisque;
            float: left;
            text-align: center;
        }

        #content {
            width: 1000px;
            height: 100%;
            background: antiquewhite;
            float: left;
        }
        .room{
            width : 150px;
            height: 225px;
            border: 1px solid red;
            margin: 40px 0px 0px 40px;
            float: left;
        }

        .room-header{
            width: 100%;
            height: 25px;
        }

        .room-body{
            width: 100%;
            height: 200px;
        }

        #aside_text{
            width: 150px;
            height: 50px;
            margin: 25px auto;
            background: lightgoldenrodyellow;
            font-weight: bold;
            font-size: 20px;
        }

        #aside_btn{
            width: 160px;
            height: 25px;
            background: burlywood;
        }

        /* ----- 팝업 디자인 시작 ----- */

        /* 뒷배경 오버레이 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 99;
        }

        /* 팝업 최상위 div */
        #pop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 700px;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
        }

        #pop-main-area {
            flex-grow: 1;
            display: flex;
        }

        #pop-content {
            flex: 7; /* 70% */
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }

        #pop-header {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
            background-color: #fff;
        }

        #pop-chat-log {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            background-color: #e9e9eb;
        }

        #pop-input-area {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #fff;
        }

        #pop-input-area input {
            width: 100%;
            height: 40px;
            padding: 0 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
        }

        #pop-aside {
            flex: 3; /* 30% */
            background-color: #fafafa;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
        }

        #pop-aside h4 {
            margin-bottom: 10px;
        }

        #pop-aside ul {
            list-style: none;
            padding: 0;
        }

        #pop-aside li {
            margin-bottom: 8px;
        }

        #pop-footer {
            height: 50px;
            line-height: 50px;
            text-align: center;
            background-color: #333;
            color: white;
            font-size: 14px;
        }

        /* ----- 팝업 디자인 끝 ----- */
    </style>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
    <h1>채팅방</h1>
    <p @click="change()">팝업 미리보기</p>
    <div id="app">

    <div id="wrapper">
        <div id="aside">
            <div th:if="${session.member}">
                <h4 th:text="${session.member.id}"></h4>
                <h4 th:text="|${session.member.name}님|"></h4>
            </div>

            <input type="hidden" th:value="${session.member.id}" name="id">
            <input type="text" id="aside_text" name="roomName" placeholder="방 제목 입력">
            <input type="button" @click="createRoom()" id="aside_btn" name="" value="채팅방 개설">
            <ul>
                <li>접속자 목록</li>
                <li v-for="member in memberList">{{member.name}}</li>
            </ul>
        </div>
        <div id="content">
            <div class="room" v-for="room in roomList" @click="joinRoom(room.uuid)">
                <div class="room-header">{{room.roomName}}</div>
                <div class="room-body"></div>
            </div>
        </div>
    </div>


        <!-- 팝업으로 띄울 채팅방 -->
        <div id="vs" v-show="false">
            <div class="overlay"></div>
            <div id="pop">
                <div id="pop-main-area">
                    <!-- 채팅 콘텐츠 영역 -->
                    <div id="pop-content">
                        <div id="pop-header">채팅방 제목</div>
                        <div id="pop-chat-log">
                            <div class="message-bubble">안녕하세요.</div>
                            <div class="message-bubble">채팅 내용이 여기에 표시됩니다.</div>
                        </div>
                        <div id="pop-input-area">
                            <input type="text" placeholder="메시지를 입력하세요...">
                        </div>
                    </div>
                    <!-- 사이드바 영역 -->
                    <div id="pop-aside">
                        <h4>참여자 목록</h4>
                        <ul>
                            <li>참여자 1</li>
                            <li>참여자 2</li>
                        </ul>
                    </div>
                </div>
                <div id="pop-footer">
                    채팅방 푸터
                </div>
            </div>
        </div>
    </div>

    <script>
        const {createApp, reactive, ref} = Vue;

        createApp({
            setup(){
                let roomList=reactive([]);
                let memberList=reactive([]);

                let ws=null; // 웹 소켓 객체


                    //서버에 요청
                    const request=(data)=>{
                        ws.send(data);
                    }

                    // 웹소켓 서버 접속
                    const connect=()=>{
                        ws = new WebSocket("ws://localhost:8989/chat/multi");

                        //접속이 성공되면..
                        ws.onopen = (event)=>{
                        }

                        // 메시지가 수신되면..
                        ws.onmessage = (e)=>{
                            console.log("접속돠 동시에 수신 받은 데이터는 ", e.data);

                            const responseJson = JSON.parse(e.data);
                            if(responseJson.responseType=="createRoom"){
                                memberList.splice(0); // 기존 배열 지우기

                                //접속자 명단
                                responseJson.memberList.forEach(member=>{
                                    memberList.push(member);
                                });


                                //채팅방 목록
                                if(responseJson.roomList!="null"){
                                    roomList.splice(0);
                                    responseJson.roomList.forEach(room=>{
                                    roomList.push(room);
                                    })
                                }

                            }
                        }

                    }


                    //방 만들기 요청 {requestType:"createRoom", userId:"아이디", roomName:"방이름"}
                    const createRoom=()=>{
                        let payload={
                            requestType:"createRoom",
                            userId: $("input[name='id']").val(),
                            roomName:$("input[name='roomName']").val()
                        }
                        console.log(payload);
                        request(JSON.stringify(payload));
                    }

                    const joinRoom=(data)=>{
                        console.log("입장 요청 메서드, UUID : ",data);
                        let payload={
                            requestType:"joinRoom",
                            uuid:data
                        }
                        console.log("payload",payload);
                        request(JSON.stringify(payload));
                    }


                    connect();
                    return {roomList, memberList,createRoom, joinRoom,connect};
            }
        }).mount("#app");
    </script>
</body>
</html>
