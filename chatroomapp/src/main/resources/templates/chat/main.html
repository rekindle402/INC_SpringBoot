<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅 메인</title>

    <style>
        body {
            background-color: #f4f7f9; /* Changed */
        }

        #wrapper {
            width: 1200px;
            height: 800px;
            margin: 0 auto;
            background: #ffffff; /* Changed */
            border-radius: 10px;
        }

        #aside {
            width: 200px;
            height: 100%;
            background: #eaf2f8; /* Changed */
            float: left;
            text-align: center;
        }

        #content {
            width: 1000px;
            height: 100%;
            background: #fdfefe; /* Changed */
            float: left;
        }

        .room {
            width: 150px;
            height: 225px;
            border: 1px solid #ddd; /* Changed for better visibility on new background */
            margin: 40px 0px 0px 40px;
            float: left;
            border-radius: 5px;
        }

        .room-header {
            width: 100%;
            height: 25px;
            background: #aed6f1; /* Changed */
        }

        .room-body {
            width: 100%;
            height: 200px;
            background: #ffffff; /* Changed */
        }

        #aside_text {
            width: 150px;
            height: 50px;
            margin: 25px auto;
            background: #ffffff; /* Changed */
            font-weight: bold;
            font-size: 20px;
        }

        #aside_btn {
            width: 160px;
            height: 25px;
            background: #3498db; /* Changed */
        }

        /* ----- 팝업 디자인 시작 ----- */

        /* 뒷배경 오버레이 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 99;
        }

        /* 팝업 최상위 div */
        #pop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 700px;
            background-color: #ffffff; /* Changed */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
        }

        #pop-main-area {
            flex-grow: 1;
            display: flex;
        }

        #pop-content {
            flex: 7; /* 70% */
            display: flex;
            flex-direction: column;
            background-color: #f8f9f9; /* Changed */
        }

        #pop-header {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
            background-color: #ffffff; /* Changed */
        }

        #pop-chat-log {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            background-color: #d4e6f1; /* Changed */
        }

        #pop-input-area {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff; /* Changed */
        }

        #pop-input-area input {
            width: 100%;
            height: 40px;
            padding: 0 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
        }

        #pop-aside {
            flex: 3; /* 30% */
            background-color: #f0f5f9; /* Changed */
            border-left: 1px solid #e0e0e0;
            padding: 20px;
        }

        #pop-aside h4 {
            margin-bottom: 10px;
        }

        #pop-aside ul {
            list-style: none;
            padding: 0;
        }

        #pop-aside li {
            margin-bottom: 8px;
        }

        #pop-footer {
            height: 50px;
            line-height: 50px;
            text-align: center;
            background-color: #2c3e50; /* Changed */
            color: white;
            font-size: 14px;
        }

        /* ----- 팝업 디자인 끝 ----- */
    </style>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<h1>채팅방</h1>
<div id="app">

    <div id="wrapper">
        <div id="aside">
            <div th:if="${session.member}">
                <h4 th:text="${session.member.id}"></h4>
                <h4 th:text="|${session.member.name}님|"></h4>
            </div>

            <input type="hidden" th:value="${session.member.id}" name="id">
            <input type="text" id="aside_text" name="roomName" placeholder="방 제목 입력">
            <input type="button" @click="createRoom()" id="aside_btn" name="" value="채팅방 개설">
            <input type="button" @click="disconnect()" id="aside_btn2" name="" value="나가기">
            <ul>
                <li>접속자 목록</li>
                <li v-for="member in memberList">{{member.name}}</li>
            </ul>
        </div>
        <div id="content">
            <div class="room" v-for="room in roomList" key="room.uuid" @click.prevent="joinRoom(room.uuid)">
                <div class="room-header">{{room.roomName}}</div>
                <div class="room-body"></div>
            </div>
        </div>
    </div>


    <!-- 팝업으로 띄울 채팅방 -->
    <div id="vs" v-show="flag">
        <div class="overlay"></div>
        <div id="pop">
            <div id="pop-main-area">
                <!-- 채팅 콘텐츠 영역 -->
                <div id="pop-content">
                    <div id="pop-header">{{roomName}}</div>
                    <div id="pop-chat-log"style="white-space: pre-line">{{message}}</div>
<!--                        <div class="message-bubble" style="white-space: pre-line">{{message}}</div>-->
                    <div id="pop-input-area">
                        <input type="text" v-model="msg" placeholder="메시지를 입력하세요..." @keyup.enter="sendMsg()">
                    </div>
                </div>
                <!-- 사이드바 영역 -->
                <div id="pop-aside">
                    <h3>방장 : {{master}}</h3>
                    <h4>참여자 목록</h4>
                    <ul>
                        <li v-for="user in userList" key="user.id">{{user.id}}</li>
                    </ul>
                    <div id="pop-footer">
                        <button>나가기</button>
                        <button  @click="fold()">접기</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const {createApp, reactive, ref} = Vue;

    createApp({
        setup() {
            let roomList = reactive([]);
            let memberList = reactive([]);
            let flag = ref(false);

            //채팅방 상세
            let roomName = ref("");
            let master = ref("");
            let userList = reactive([]); //참여자 목록
            let uuid = ref(""); // 방 id
            let msg = ref(""); // 전송할 채팅 메시지
            let message = ref(""); // 채팅 로그에 사용될 바인딩 변수

            let ws = null; // 웹 소켓 객체

            const request = (data) => {
                ws.send(data);
            }

            // 웹소켓 서버 접속
            const connect = () => {
                ws = new WebSocket("ws://localhost:8989/chat/multi");

                //접속이 성공되면..
                ws.onopen = (event) => {
                }

                ws.onmessage = (event) => {
                    console.log();
                }


                // 메시지가 수신되면..
                ws.onmessage = (e) => {
                    console.log("접속돠 동시에 수신 받은 데이터는 ", e.data);

                    const responseJson = JSON.parse(e.data);
                    if (responseJson.responseType == "createRoom") {
                        memberList.splice(0); // 기존 배열 지우기

                        //접속자 명단
                        responseJson.memberList.forEach(member => {
                            memberList.push(member);
                        });


                        //채팅방 목록
                        if (responseJson.roomList != "null") {
                            roomList.splice(0);
                            responseJson.roomList.forEach(room => {
                                roomList.push(room);
                            })
                        }
                    }

                    else if (responseJson.responseType == "chat") {
                        let sender = responseJson.sender;
                        console.log(sender);
                        let data = responseJson.data;
                        console.log(data);
                        let uuid = responseJson.uuid;

                        message.value+=`${sender}님 : ${data}\n`;
                    }


                    else if (responseJson.responseType == "joinRoom") {
                        roomName.value = responseJson.room.roomName;
                        master.value = responseJson.room.master;
                        console.log(responseJson.uuid);
                        uuid.value = responseJson.room.uuid;

                        userList.splice(0);
                        responseJson.room.userList.forEach(user => {
                            userList.push(user);
                        })
                        flag.value = !flag.value;
                    }

                }

            }


            //방 만들기 요청 {requestType:"createRoom", userId:"아이디", roomName:"방이름"}
            const createRoom = () => {
                let payload = {
                    requestType: "createRoom",
                    userId: $("input[name='id']").val(),
                    roomName: $("input[name='roomName']").val()
                }
                console.log(payload);
                request(JSON.stringify(payload));
            }

            const joinRoom = (roomId) => {
                const joinConfirmed = confirm("방에 입장 하시겠습니까??");

                if (joinConfirmed) {
                    console.log("입장 요청 메서드, UUID : ", roomId);
                    let payload = {
                        requestType: "joinRoom",
                        uuid: roomId,
                        userId: $("input[name='id']").val()
                    }
                    request(JSON.stringify(payload));
                }
            }

            const sendMsg = () => {
                let payload = {
                    requestType: "chat",
                    sender: $("input[name='id']").val(),
                    data : msg.value,
                    uuid: uuid.value
                }
                console.log(payload);
                request(JSON.stringify(payload));
                msg.value = "";
            }

            const fold = ()=>{
                flag.value = !flag.value;
            }

            //서버와 접속 끊기
            const disconnect = () => {
                ws.disconnect();
            }


            connect();
            return {msg, roomName, master, userList, uuid, flag, roomList, memberList, message, sendMsg, fold, createRoom, joinRoom, connect, disconnect};
        }
    }).mount("#app");
</script>
</body>
</html>
